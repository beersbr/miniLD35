<!DOCTYPE html>
<html>
<head>
	<title>Mini LD 35 :: Ship Defence</title>
</head>

<link rel="stylesheet" type="text/css" href="css/main.css">

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="js/InputHandler.js"></script>

<script type="text/javascript">

window.requestAnimFrame = (function(callback){
    return window.requestAnimationFrame ||
    window.webkitRequestAnimationFrame ||
    window.mozRequestAnimationFrame ||
    window.oRequestAnimationFrame ||
    window.msRequestAnimationFrame ||
    function(callback){
        window.setTimeout(callback, 1000 / 60);
    };
})();

WINDOW_MAX_WIDTH = 800;
WINDOW_MAX_HEIGHT = 600;

balls = [];
enemies = [];

Images = {};

Images["background"] = new Image();
Images["background"].src = "img/background.png";

Images["bullet"] = new Image();
Images["bullet"].src = "img/bullet.png";

Player = {}

// Player.bullet_count = 6;

// This will have to be somewhat dynamic for the many bullets that the other firing modes provide
Player.bullet_count_max = 6;
Player.bullet_fire_speed = 40;
Player.bullet_fire_lastshot = 0;

Player.score = 0.0;
Player.time_played = 0.0;
Player.shields = 100.0;
Player.wave = 1;
Player.enemies_left = 0;

Player.total_shots = 0;
Player.total_hits = 0;

Player.accuracy = function(){

	var ac = (Player.total_hits/Player.total_shots).toFixed(2);
	if(isNaN(ac)) return "0";
	return ac*100;
}

Player.max_wave_enemies = 10;
Player.enemy_spawn_rate = 0.01; // 1% to start off

Player.bullet_properties = {};
Player.gun_type = "single";

Player.gun_types = {
	single: function(args){

		width = args.w;
		height = args.h;
		hypotenuse = args.hyp;
		power = args.pow;

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2,
							ax: (width/hypotenuse)*power,
							ay: -((height)/hypotenuse)*power
						}));
	},

	double: function(args){
		width = args.w;
		height = args.h;
		hypotenuse = args.hyp;
		power = args.pow;

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2,
							ax: (width/hypotenuse)*power,
							ay: -((height-100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2,
							ax: (width/hypotenuse)*power,
							ay: -((height+100)/hypotenuse)*power
						}));
	},

	triple: function(args){
		width = args.w;
		height = args.h;
		hypotenuse = args.hyp;
		power = args.pow;

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2,
							ax: (width/hypotenuse)*power,
							ay: -((height-100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2,
							ax: (width/hypotenuse)*power,
							ay: -((height)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2,
							ax: (width/hypotenuse)*power,
							ay: -((height+100)/hypotenuse)*power
						}));
	},

	twin_single: function(args){
		width = args.w;
		height = args.h;
		hypotenuse = args.hyp;
		power = args.pow;

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2+10,
							ax: (width/hypotenuse)*power,
							ay: -((height)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2-10,
							ax: (width/hypotenuse)*power,
							ay: -((height)/hypotenuse)*power
						}));
	},

	twin_double: function(args){
		width = args.w;
		height = args.h;
		hypotenuse = args.hyp;
		power = args.pow;

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2+30,
							ax: (width/hypotenuse)*power,
							ay: -((height-100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2+10,
							ax: (width/hypotenuse)*power,
							ay: -((height-100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2-10,
							ax: (width/hypotenuse)*power,
							ay: -((height+100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2-30,
							ax: (width/hypotenuse)*power,
							ay: -((height+100)/hypotenuse)*power
						}));
	},

	twin_triple: function(args){
		width = args.w;
		height = args.h;
		hypotenuse = args.hyp;
		power = args.pow;

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2+60,
							ax: (width/hypotenuse)*power,
							ay: -((height-100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2+30,
							ax: (width/hypotenuse)*power,
							ay: -((height-100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2+10,
							ax: (width/hypotenuse)*power,
							ay: -((height)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2-10,
							ax: (width/hypotenuse)*power,
							ay: -((height)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2-30,
							ax: (width/hypotenuse)*power,
							ay: -((height+100)/hypotenuse)*power
						}));

		balls.push(new Ball({x: 0,
							y: WINDOW_MAX_HEIGHT/2-60,
							ax: (width/hypotenuse)*power,
							ay: -((height+100)/hypotenuse)*power
						}));
	}
};

Player.shoot = function(args){
	Player.total_shots += 1;
	this.gun_types[this.gun_type](args);
}

// accepts two object
// object{x, y, w, h}
function intersection(a, b){
	return (Math.abs(a.x - b.x) * 2 < (a.w + b.w)) && (Math.abs(a.y - b.y) * 2 < (a.h + b.h));
}

function Ball(args){
	if(args == undefined) args = {};

	this.x = args.x || 0;
	this.y = args.y || 0;
	this.w = args.w || 10;
	this.h = args.h || 10;

	this.mass = 1.0;
	this.damage = 1.0 || args.damage;

	this.ax = args.ax || 0.0;
	this.ay = args.ay || 0.0;
	this.rotation = 0.0;

	this.draw = function(rc){
		rc.drawImage(Images.bullet, this.x-5, this.y-5);
	}

	this.update = function(args){
		if(args == undefined) args = {};

		var en_len = enemies.length;
		if(en_len > 0){
			var thisbox = {x: this.x, y: this.y, w: this.w, h: this.h};

			for(var i = 0; i < en_len; i++){
				var enemy = enemies[i];
				var enbox = {x: enemy.x, y: enemy.y, w: enemy.w, h: enemy.h};

				if(intersection(enbox, thisbox)){
					enemy.health -= this.damage;
					Player.total_hits += 1;
					return false;
				}
			}
		}

		this.y += this.ay;
		this.x += this.ax;		

		if(this.y > WINDOW_MAX_HEIGHT || this.y < 0) return false;
		if(this.x > WINDOW_MAX_WIDTH || this.x < 0) return false;

		return true;
	}
}

function Item(args){
	if(args == undefined) args = {};
}

function Enemy(args){
	if(args == undefined) args = {};

	this.x = args.x || 0;
	this.y = args.y || 0;
	this.w = args.w || 10;
	this.h = args.h || 10;

	this.mass = 1.0;
	this.health = 1 || args.health;

	this.ax = args.ax || 0.0;
	this.ay = args.ay || 0.0;
	this.rotation = 0.0;

	this.draw = function(rc){
		rc.save();
		rc.fillStyle = "rgb(255, 0, 255)";
		rc.fillRect(this.x - this.w/2, this.y - this.h/2, this.w, this.h);
		rc.restore();
	}

	this.update = function(args){

		if(this.health == 0) return false;

		this.x += this.ax;

		if(this.y > WINDOW_MAX_HEIGHT || this.y < 0) return false;
		if(this.x > WINDOW_MAX_WIDTH || this.x < 0) return false;

		return true;
	}
}

function RenderHUD(rc){

	rc.save();
	rc.fillStyle = "rgb(255, 255, 255)";
	rc.font = "12pt sans-serif";
	rc.fillText("Health: "+Player.shields, 5, 16);
	rc.fillText("Accuracy: "+Player.accuracy()+"%", 100, 16);
	rc.fillText("Bullets: "+(Player.bullet_count_max-balls.length)+"/"+Player.bullet_count_max, 230, 16);
	rc.restore();
}

function RenderFrame(){
	//context.clearRect(0, 0, WINDOW_MAX_WIDTH, WINDOW_MAX_HEIGHT);
	context.drawImage(Images.background, 0, 0);

	Player.bullet_fire_lastshot += 1;

	var click = input.clicked();
	if(click != undefined){
		var width = 0 + click.x;
		var height = WINDOW_MAX_HEIGHT/2 - click.y;
		var hypotenuse = Math.sqrt(Math.pow(width, 2) + Math.pow(height, 2));
		var power = hypotenuse/(WINDOW_MAX_WIDTH/4.5);

		if(Player.bullet_fire_lastshot > Player.bullet_fire_speed && balls.length < Player.bullet_count_max){
			Player.shoot({w: width, h: height, hyp: hypotenuse, pow: power});
			Player.bullet_fire_lastshot = 0;
		}
	}

	// draw bullets
	for(var i = 0; i < balls.length; i++){
		if(!balls[i].update()){
			balls.splice(i, 1);
			continue;
		}
		balls[i].draw(context);
	}

	// update the enemies
	if(Math.random() < 0.5/100){
		var ypos = Math.random()*WINDOW_MAX_HEIGHT;

		enemies.push(new Enemy({x: WINDOW_MAX_WIDTH,
								y: ypos,
								ax: -0.2
						}));
	}

	for(var i = 0; i < enemies.length; i++){
		if(!enemies[i].update()){
			enemies.splice(i, 1);
			continue;
		}
		enemies[i].draw(context);
	}

	RenderHUD(context);

	requestAnimFrame(function(){
		RenderFrame();
	});
}

window.onload = function(){
	canvas = document.getElementById("game-canvas");
	context = canvas.getContext("2d");

	var gc = document.getElementById("game-canvas");
	input = new InputHandler(gc);

	RenderFrame();
}

</script>

<body>
	<canvas id='game-canvas' width='800px' height='600px'></canvas>
</body>
</html>